{% extends "base.html" %}

{% block titulo %} New Loan {% endblock %}

{% block contenido %}  

{%include '../navbar.html'%}

{%load static%}

<div class="container form--addLoan">
    <div class="row">
        <div class="col-3">
            <h3>{{system.Name}}</h3>
            <br>
            <p>
                <b>Ammount:</b> ${{system.Ammount}} USD
            </p>
            <p>
                <b>Loan Term:</b> {{loanInfo.monthsTerm}} months.
            </p>
            <p>
                <b>Interest Rate:</b> {{loanInfo.interestEA}}% EA
            </p>
            <p>
                <b>Payment:</b> ${{loanInfo.monthlyPayment}} USD
            </p>
        </div>
        <div class="col-9">
            <div id="graphic"></div>
        </div>
    </div>
    <div class="row" style="margin-top: 100px;">
        <div class="col-4">
            <div data-bs-toggle="modal" data-bs-target="#amortizationSchedule">
                <div class="action-card">
                    <div class="action-card-img" style="background-image: url({% static 'images/table-summary.svg' %});">
                        <h4>Amortization Schedule</h4>
                    </div>
                </div>
                <div class="action-card-text">
                    <p>Show a table that lists each regular payment on a loan over time.</p>
                </div>
            </div>
        </div>

        <div class="col-4">
            <div data-bs-toggle="modal" data-bs-target="#regularPayments">
                <div class="action-card">
                    <div class="action-card-img" style="background-image: url({% static 'images/money-summary.svg' %});">
                        <h4>Regular Payments</h4>
                    </div>
                </div>
                <div class="action-card-text">
                    <p>Add payments to your loan according to the Amortization Schedule</p>
                </div>
            </div>
        </div>

        <div class="col-4">
            <div>
                <div class="action-card">
                    <div class="action-card-img" style="background-image: url({% static 'images/coin-summary.svg' %});">
                        <h4>Extra Payments</h4>
                    </div>
                </div>
                <div class="action-card-text">
                    <p>Add some extra payments to the Amortization Schedule</p>
                </div>
            </div>
        </div>
        
    </div>
    <div class="row" style="margin-top: 50px;">
        <a href="{% url 'loans' %}"><button class="button--regular" type="submit" onclick="saveLoanInfo()">Save</button></a>
    </div>
    
</div>

<!-- Modal Amortization Schedule -->
<div class="modal fade" id="amortizationSchedule" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Amortization Schedule</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <table class="table table-hover">
                <thead>
                    <tr class="table-info">
                        <th scope="col">#</th>
                        <th scope="col">Date</th>
                        <th scope="col">Payment</th>
                        <th scope="col">Interest</th>
                        <th scope="col">Principal</th>
                        <th scope="col">Balance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for date in loanSchedule %}
                        <tr>
                            <th scope="row">{{date.item}}</th>
                            <td>{{date.date}}</td>
                            <td>$ {{date.payment}} USD</td>
                            <td>$ {{date.interest}} USD</td>
                            <td>$ {{date.principal}} USD</td>
                            <td>$ {{date.balance}} USD</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
        </div>
        </div>
    </div>
</div>

<!-- Modal Regular Payments -->
<div class="modal fade" id="regularPayments" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Regular Payments</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <table class="table table-hover" id="tblRegularPayment">
                <thead>
                    <tr class="table-info">
                        <th scope="col"></th>
                        <th scope="col">#</th>
                        <th scope="col">Date</th>
                        <th scope="col">Payment</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in loanSchedule %}
                        <tr>
                            <td><input type="checkbox" name="payments[]" class="paymentCheck" value="{{payment.item}}"></td>
                            <th scope="row">{{payment.item}}</th>
                            <td>{{payment.date}}</td>
                            <td class="payment">$ {{payment.payment}} USD</td>
                        </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="4">
                            <span id="totalPayment"></span>
                        </td>
                    </tr>
                </tbody>
            </table>
            
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
        </div>
        </div>
    </div>
</div>

<style>
    div.action-card {
        background: rgb(203,245,255); 
        background: linear-gradient(108deg, rgba(203,245,255,1) 0%, rgba(98,213,242,1) 51%, rgba(71,153,228,1) 100%); 
        height: 130px; 
        border-radius: 8px 8px 0px 0px; 
        box-shadow: 1px 3px 10px #00000017;
    }

    div.action-card:hover {
        background: rgb(255,255,255);
        background: linear-gradient(86deg, rgba(255,255,255,1) 0%, rgba(106,212,255,1) 100%);
        cursor: pointer;
    }

    div.action-card h4{
        color:#2F3646; padding: 20px 20px 20px 20px;
    }

    div.action-card-text {
        background-color: #f0f0f0; border-radius: 0px 0px 8px 8px;
    }

    div.action-card-text p{
        padding: 20px 20px 20px 20px;
    }

    div.action-card-img {
        background-repeat: no-repeat;
        background-position: right bottom;
        height: 100%;
    }
</style>

<script>
//  POST request to save de loan data

    function saveLoanInfo(){
        const Url = 'saveLoan';
        var payment = [];
        //Insertar toda la información de la cuota aquí
        $('#tblRegularPayment input:checked').each(function() {
            payment.push($(this).attr('value'));
        });
        $.post(
            Url,
            {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                Name : '{{system.Name}}',
                Ammount : '{{system.Ammount}}',
                Term : '{{loanInfo.monthsTerm}}',
                InterestRate : '{{loanInfo.interestEA}}',
                StartDate : '{{system.StartDate}}',
                DisbursementDate : '{{system.DisbursementDate}}',
                loanPeriod : '{{system.loanPeriod}}',
                monthlyPayment : '{{loanInfo.monthlyPayment}}',
                termCalendar : '{{system.termCalendar}}',
                Compound : '{{system.Compound}}',
                Payments : payment
            },
            function(data, status) {
                if(status === "success") {
                    console.log("Post successfully created!");
                    // window.location.href = 'loans'
                }
            },
            "json"
        )
    }

    Highcharts.chart('graphic', {
        chart: {
            type: 'areaspline',
            backgroundColor: 'rgba(0,0,0,0)'
        },
        title: {
            text: 'Loan Performance'
        },
        subtitle: {
            text: ''
        },
        xAxis: {
            categories: [ {{ loanChart.categories | safe}}],
            plotBands: [{
            from: 4.5,
            to: 6.5,
            color: 'rgba(68, 170, 213, .2)'
        }]
        },
        yAxis: {
            title: {
                text: 'Payment'
            }
        },
        tooltip: {
            shared: true,
            valueSuffix: ' USD'
        },
        credits: {
            enabled: false
        },
        plotOptions: {
            areaspline: {
                fillOpacity: 0.5
            }
        },
        series: [{
            name: 'Comulative Interest',
            data: [{{ loanChart.interest | safe}}]
        }, {
            name: 'Principal Paid',
            data: [{{ loanChart.principal | safe}}]
        }, {
            name: 'Balance',
            data: [{{ loanChart.balance | safe}}]
        }]
    });

    $('input:checkbox').change(function ()
    {
        var total = 0;
        var totalStr = '';
        $('input:checkbox:checked').each(function(){
            let pay = $(this).parents('tr').find("td").eq(2).text();
            var payS = pay.split(" ");
            total += isNaN(parseFloat(payS[1])) ? 0 : parseFloat(payS[1]);
            totalStr = "Total Payment: <b>$" + String(total.toFixed(2)) + " USD</b>";
        });

        $("#totalPayment").html(totalStr);
    });

    window.addEventListener('load', function () {
        enableRegularPayments();
    });

    function enableRegularPayments() {
        let ckPayments = document.getElementsByClassName('paymentCheck').length;
        for (var i = 0; i < ckPayments; i++) {
            document.getElementsByClassName('paymentCheck')[i].disabled= true;
        }
        document.getElementsByClassName('paymentCheck')[0].disabled= false;
    }
 
    $('.paymentCheck').change(function(){
        var i = $('.paymentCheck').index(this)
        if ($(this).is(':checked')) {
            $('.paymentCheck')[ i + 1].disabled= false;
            $('.paymentCheck')[i - 1].disabled= true;
        } else {
            $('.paymentCheck')[i + 1].disabled= true;
            $('.paymentCheck')[i - 1].disabled= false;
        }
    });

  </script>


{% endblock %}